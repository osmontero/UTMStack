<div [formGroup]="group" class="card-body">
  <div class="row">
    <div class="col-md-4">
      <h6 class="text-muted mb-3">Available Actions</h6>
      <div *ngFor="let action of predefinedActions" class="card mb-2 available-action" (click)="addToWorkFlow(action)">
        <div class="card-body d-flex align-items-center">
          <span class="me-2 fs-5">{{ action.icon }}</span>
          <span>{{ action.label }}</span>
        </div>
      </div>

      <button class="btn btn-outline-secondary mt-3 w-100">âž• Add Custom Action</button>
    </div>

    <div class="col-md-8">
      <h6 class="text-success mb-3">Action Workflow</h6>

      <div *ngIf="noPlatforms"
           class="w-100 alert alert-danger alert-styled-right mt-3">
       <span class="font-weight-semibold">
          You need to install at least one agent!
       </span>
      </div>

      <div class="d-flex flex-column">
        <div class="col-12 p-0">
          <label class="pb-1" for="exclude">Agent platform is</label>
          <ng-select [clearable]="false"
                     [items]="platforms$ | async"
                     [loadingText]="'Loading platforms...'"
                     [loading]="loadingPlatforms"
                     (change)="getAgents($event)"
                     formControlName="agentPlatform"
                     [ngClass]="inputClass.resolveClassInput(group.get('agentPlatform'))"
                     id="platform">
          </ng-select>
          <app-formcontrol-error [formcontrol]="group.get('agentPlatform')"></app-formcontrol-error>
        </div>
      </div>
      <div class="d-flex mt-3 flex-column">
        <div class="alert alert-info alert-styled-right mb-2 info-dismissible">
          <span class="font-weight-semibold">Info! </span>
          <span>Select the agent handling strategy for the automation. If <strong>not active</strong>, commands will run on specified platform agents if the trigger conditions and dataSource field value of the alert match. Alternatively, choose a <strong>default agent</strong> to run the automation if no other agent matches the criteria. If this option is <strong>active</strong>, commands will run only on specified platform agents if the trigger conditions and dataSource field value of the alert match, if not, the <strong>automation won't be executed</strong>.</span>
        </div>
        <app-utm-toggle (toggleChange)="onChangeToggle($event)"
                        [active]="group.get('agentType').value"
                        [emitAtStart]="false"
                        [customClass]="'pl-3'"
                        [label]="'Run on specific agent'"></app-utm-toggle>
      </div>
      <!--<div *ngIf="!group.get('agentType').value" class="d-flex mt-2 mb-3 flex-column">
        <div class="col-12 p-0">
          <label class="pb-1" for="exclude">Exclude agents</label>
          <ng-select [clearable]="false"
                     [items]="agents$ | async"
                     [placeholder]="'Select agents to exclude'"
                     [loading]="loadingAgents"
                     [virtualScroll]="true"
                     [multiple]="true"
                     formControlName="excludedAgents"
                     (change)="onChangeExclude($event)"
                     bindValue="assetName"
                     bindLabel="assetName"
                     id="exclude">
          </ng-select>
        </div>
      </div>-->

      <!--<div *ngIf="group.get('agentType').value" class="d-flex mt-2 mb-3 flex-column">
        <div  class="col-12 p-0">
          <label class="pb-1" for="exclude">Default agent</label>
          <ng-select [clearable]="false"
                     [items]="agents"
                     [placeholder]="'Select agent'"
                     [loadingText]="'Loading agents...'"
                     [virtualScroll]="true"
                     formControlName="defaultAgent"
                     bindValue="assetName"
                     bindLabel="assetName"
                     id="default">
          </ng-select>
        </div>
        <div class="col-12 p-0">
          <div class="alert alert-info alert-styled-right mt-2 info-dismissible">
            <span class="font-weight-semibold">Info! </span>
            <span>Designates the agent to execute the automation when no other agent meets the criteria to serve as the runner for this automation.</span>
          </div>
        </div>
      </div>-->

      <div class="d-flex mt-2 mb-3 flex-column">
        <div class="col-12 p-0">
          <label class="pb-1" [for]="group.get('agentType').value ? 'default' : 'exclude'">
            {{ group.get('agentType').value ? 'Default agent' : 'Exclude agents' }}
          </label>

          <ng-select
            [clearable]="false"
            [items]="agents$ | async"
            [placeholder]="group.get('agentType').value ? 'Select agent' : 'Select agents to exclude'"
            [loading]="loadingAgents"
            [virtualScroll]="true"
            [multiple]="!group.get('agentType').value"
            [loadingText]="'Loading agents...'"
            [formControlName]="group.get('agentType').value ? 'defaultAgent' : 'excludedAgents'"
            [bindValue]="'assetName'"
            [bindLabel]="'assetName'"
            [id]="group.get('agentType').value ? 'default' : 'exclude'"
            (change)="!group.get('agentType').value && onChangeExclude($event)">
          </ng-select>
        </div>
        <div *ngIf="group.get('agentType').value" class="col-12 p-0">
          <div class="alert alert-info alert-styled-right mt-2 info-dismissible">
            <span class="font-weight-semibold">Info! </span>
            <span>Designates the agent to execute the automation when no other agent meets the criteria to serve as the runner for this automation.</span>
          </div>
        </div>
      </div>


      <div class="d-flex flex-column align-items-stretch gap-3 w-100">
        <div *ngFor="let action of workflow; let i = index" class="w-100">
          <div class="card workflow-card mb-0">
            <div class="card-body d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <span class="me-3 fs-4">{{ action.icon }}</span>
                <div>
                  <h6 class="mb-0">{{ action.label }}</h6>
                  <small class="text-muted">{{ action.description }}</small>
                </div>
              </div>
              <button class="btn btn-sm btn-outline-danger" (click)="removeAction(i)">ðŸ—‘</button>
            </div>
          </div>

          <div *ngIf="i < workflow.length - 1" class="text-center workflow-arrow">
            â†“
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
