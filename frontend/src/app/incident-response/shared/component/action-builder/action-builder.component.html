<div class="playbook-trigger-header panel panel-default">
  <div class="panel-body d-flex align-items-center">
    <div class="trigger-icon text-primary">
      <i class="glyphicon glyphicon-flash"></i>
    </div>
    <div class="ml-2">
      <h4 class="panel-title m-0">Playbook Actions</h4>
      <small class="text-muted">These actions define what this automation will do once triggered</small>
    </div>
  </div>
</div>

<div [formGroup]="group" class="card-body">
  <div class="row">
    <div class="col-md-12">
      <div *ngIf="noPlatforms"
           class="w-100 alert alert-danger alert-styled-right mt-3">
       <span class="font-weight-semibold">
          You need to install at least one agent!
       </span>
      </div>

      <div class="alert alert-info alert-styled-right mb-2 info-dismissible">
        <span class="font-weight-semibold">Info! </span>
        <span>Select the agent handling strategy for the automation. If <strong>not active</strong>, commands will run on specified platform agents if the trigger conditions and dataSource field value of the alert match. Alternatively, choose a <strong>default agent</strong> to run the automation if no other agent matches the criteria. If this option is <strong>active</strong>, commands will run only on specified platform agents if the trigger conditions and dataSource field value of the alert match, if not, the <strong>automation won't be executed</strong>.</span>
      </div>

      <div class="d-flex mt-3 mb-3 flex-column">
        <app-utm-toggle (toggleChange)="onChangeToggle($event)"
                        [active]="group.get('agentType').value"
                        [emitAtStart]="false"
                        [customClass]="'pl-3'"
                        [label]="'Run on specific agent'"></app-utm-toggle>
      </div>

      <div class="row">
        <div class="col-6">
          <label class="pb-1" for="exclude">Agent platform is</label>
          <ng-select [clearable]="false"
                     [items]="platforms$ | async"
                     [loadingText]="'Loading platforms...'"
                     [loading]="loadingPlatforms"
                     (change)="getAgents($event)"
                     formControlName="agentPlatform"
                     [ngClass]="inputClass.resolveClassInput(group.get('agentPlatform'))"
                     id="platform">
          </ng-select>
          <app-formcontrol-error [formcontrol]="group.get('agentPlatform')"></app-formcontrol-error>
        </div>

        <div class="col-6">
          <label class="pb-1" [for]="group.get('agentType').value ? 'default' : 'exclude'">
            {{ group.get('agentType').value ? 'Default agent' : 'Exclude agents' }}
          </label>

          <ng-select
            [clearable]="false"
            [items]="agents$ | async"
            [placeholder]="group.get('agentType').value ? 'Select agent' : 'Select agents to exclude'"
            [loading]="loadingAgents"
            [virtualScroll]="true"
            [multiple]="!group.get('agentType').value"
            [loadingText]="'Loading agents...'"
            [formControlName]="group.get('agentType').value ? 'defaultAgent' : 'excludedAgents'"
            [bindValue]="'assetName'"
            [bindLabel]="'assetName'"
            [id]="group.get('agentType').value ? 'default' : 'exclude'"
            (change)="!group.get('agentType').value && onChangeExclude($event)">
          </ng-select>
        </div>
      </div>

      <div class="d-flex mt-2 mb-3 flex-column">
        <div *ngIf="group.get('agentType').value" class="col-12 p-0">
          <div class="alert alert-info alert-styled-right mt-2 info-dismissible">
            <span class="font-weight-semibold">Info! </span>
            <span>Designates the agent to execute the automation when no other agent meets the criteria to serve as the runner for this automation.</span>
          </div>
        </div>
      </div>


      <div *ngIf="workflow$ | async as workflow" class="card phantom-action py-4 px-5 workflow-card align-items-center">

        <div class="workflow-timeline mb-3">

          <div *ngFor="let action of workflow; let first = first" class="action-wrapper d-flex flex-column align-items-center w-100">
            <!-- Action block -->
            <div class="action-block d-flex flex-column align-items-center justify-content-center w-100" style="height: 130px;">

              <div class="d-flex flex-column w-100 justify-content-center">
                <app-action-conditional *ngIf="!first" [option]="action.conditional" (optionChange)="updateAction(action, $event)" class="pr-2"></app-action-conditional>
                <div class="card-body pt-2 d-flex align-items-center justify-content-between mb-2" style="width: 100%;">
                  <div class="d-flex align-items-center">
                      <div class="icon-box mr-2" style="margin-right: 8px;"></div>
                    <div>
                      <div class="fw-bold">{{ action.label }}</div>
                      <small class="text-muted">{{ action.description }}</small>
                    </div>
                  </div>
                  <div class="icon-bin font-size-xs text-danger cursor-pointer" (click)="removeAction(action)"></div>
                </div>
              </div>

            </div>

            <div *ngIf="workflow" class="timeline-connector">
              <div class="line-vertical"></div>
              <div class="arrow-down">&#x2193;</div>
            </div>
          </div>

          <div class="action-block d-flex flex-column align-items-center justify-content-center w-100 border-dash cursor-pointer" style="height: 88px">
            <div (click)="openActionSidebar()" class="card-body d-flex flex-column w-100 justify-content-center" style="min-height: 70px;">

            <div class="d-flex align-items-center justify-content-between mb-2" style="width: 100%;">
              <div class="d-flex align-items-center">
                <div class="icon-terminal mr-2" style="margin-right: 8px;"></div>
                <div>
                  <div class="fw-bold">Add New Action</div>
                  <small class="text-muted">Define your own</small>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>

        <app-utm-code-view style="width: 800px" class="mt-3" *ngIf="command$ | async as command" [code]="command" [allowCopy]="false"></app-utm-code-view>

      </div>

    </div>
  </div>
</div>
