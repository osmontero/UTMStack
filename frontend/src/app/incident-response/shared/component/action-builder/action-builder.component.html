<div [formGroup]="group" class="card-body">
  <div class="row">
    <div class="col-md-12">
      <h6 class="text-success mb-3">Action Workflow</h6>

      <div *ngIf="noPlatforms"
           class="w-100 alert alert-danger alert-styled-right mt-3">
       <span class="font-weight-semibold">
          You need to install at least one agent!
       </span>
      </div>

      <div class="alert alert-info alert-styled-right mb-2 info-dismissible">
        <span class="font-weight-semibold">Info! </span>
        <span>Select the agent handling strategy for the automation. If <strong>not active</strong>, commands will run on specified platform agents if the trigger conditions and dataSource field value of the alert match. Alternatively, choose a <strong>default agent</strong> to run the automation if no other agent matches the criteria. If this option is <strong>active</strong>, commands will run only on specified platform agents if the trigger conditions and dataSource field value of the alert match, if not, the <strong>automation won't be executed</strong>.</span>
      </div>

      <div class="d-flex mt-3 mb-3 flex-column">
        <app-utm-toggle (toggleChange)="onChangeToggle($event)"
                        [active]="group.get('agentType').value"
                        [emitAtStart]="false"
                        [customClass]="'pl-3'"
                        [label]="'Run on specific agent'"></app-utm-toggle>
      </div>

      <div class="row">
        <div class="col-6">
          <label class="pb-1" for="exclude">Agent platform is</label>
          <ng-select [clearable]="false"
                     [items]="platforms$ | async"
                     [loadingText]="'Loading platforms...'"
                     [loading]="loadingPlatforms"
                     (change)="getAgents($event)"
                     formControlName="agentPlatform"
                     [ngClass]="inputClass.resolveClassInput(group.get('agentPlatform'))"
                     id="platform">
          </ng-select>
          <app-formcontrol-error [formcontrol]="group.get('agentPlatform')"></app-formcontrol-error>
        </div>

        <div class="col-6">
          <label class="pb-1" [for]="group.get('agentType').value ? 'default' : 'exclude'">
            {{ group.get('agentType').value ? 'Default agent' : 'Exclude agents' }}
          </label>

          <ng-select
            [clearable]="false"
            [items]="agents$ | async"
            [placeholder]="group.get('agentType').value ? 'Select agent' : 'Select agents to exclude'"
            [loading]="loadingAgents"
            [virtualScroll]="true"
            [multiple]="!group.get('agentType').value"
            [loadingText]="'Loading agents...'"
            [formControlName]="group.get('agentType').value ? 'defaultAgent' : 'excludedAgents'"
            [bindValue]="'assetName'"
            [bindLabel]="'assetName'"
            [id]="group.get('agentType').value ? 'default' : 'exclude'"
            (change)="!group.get('agentType').value && onChangeExclude($event)">
          </ng-select>
        </div>
      </div>

      <div class="d-flex mt-2 mb-3 flex-column">
        <div *ngIf="group.get('agentType').value" class="col-12 p-0">
          <div class="alert alert-info alert-styled-right mt-2 info-dismissible">
            <span class="font-weight-semibold">Info! </span>
            <span>Designates the agent to execute the automation when no other agent meets the criteria to serve as the runner for this automation.</span>
          </div>
        </div>
      </div>


      <div *ngIf="workflow$ | async as workflow" class="card phantom-action py-4 px-5 workflow-card">
        <div style="height: 70px" *ngFor="let action of workflow" class="d-flex flex-column align-items-center justify-content-center action-block">
          <div style="min-height: 70px !important;" class="card-body d-flex flex-column w-100 justify-content-center">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="d-flex align-items-center">
                <div class="icon-box mr-2"></div>
                <div>
                  <div class="fw-bold">{{ action.label }}</div>
                  <small class="text-muted">{{ action.description }}</small>
                </div>
              </div>
              <div class="icon-bin text-danger cursor-pointer" (click)="removeAction()">
              </div>
            </div>
          </div>

        </div>

        <ng-container *ngIf="workflow.length === 0">
          <div class="card-body d-flex flex-column align-items-center justify-content-center text-muted text-center">
            <div class="icon-plus2 fs-4 mb-2"></div>
            <div class="fw-bold">Add Next Action</div>
            <small class="text-muted">Click an action or define your own</small>
          </div>
        </ng-container>
      </div>

    </div>
  </div>
</div>
