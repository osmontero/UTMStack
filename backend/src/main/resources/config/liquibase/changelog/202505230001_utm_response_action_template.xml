<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="20250523001" author="Manuel">

        <sql dbms="postgresql" splitStatements="true" stripComments="true">
        <![CDATA[
            create sequence if not exists utm_response_action_template_id_seq start with 10000;

            create table utm_response_action_template (
                                                          id bigint default nextval('utm_response_action_template_id_seq') primary key,
                                                          title varchar(150) not null,
                                                          description text,
                                                          command text not null,
                                                          system_owner boolean not null
            );

            insert into utm_response_action_template (id, title, description, command, system_owner) values
                                                                                       (1, 'Create Incident', 'Creates a new incident', 'Invoke-Incident -Create -Title "New Security Incident"', true),
                                                                                       (2, 'Change Status to "under_review"', 'Marks alert as under review', 'Update-AlertStatus -Id $AlertId -Status "under_review"', true),
                                                                                       (3, 'Send Email', 'Send a notification email', 'Send-Mail -To "secops@example.com" -Subject "Alert Under Review" -Body "An alert has been flagged for review."', true),
                                                                                       (4, 'Block IP', 'Blocks the source IP address at the firewall', 'Block-IP -Address $SourceIP', true),
                                                                                       (5, 'Restart Service', 'Restarts a critical service on affected asset', 'Restart-Service -Name "nginx" -ComputerName $TargetHost', true),
                                                                                       (6, 'Log to SIEM', 'Sends a log entry to SIEM system', 'Write-SIEMLog -Message "Incident created for $AlertId"', true);

            create table utm_alert_response_rule_template (
                                                              rule_id bigint not null,
                                                              template_id bigint not null,
                                                              primary key (rule_id, template_id),
                                                              constraint fk_rule_template_rule foreign key (rule_id) references utm_alert_response_rule(id) on delete cascade,
                                                              constraint fk_rule_template_template foreign key (template_id) references utm_response_action_template(id) on delete cascade
            );

        ]]>
    </sql>
    </changeSet>
</databaseChangeLog>