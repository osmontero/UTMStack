<app-utm-modal-header name="Two-Factor Authentication" [type]="'normal'"></app-utm-modal-header>

<div class="modal-container d-flex justify-content-center align-items-center w-100 h-100">
  <div class="card border-0" style="max-width: 400px; box-shadow: unset">
    <div class="modal-body px-0">

      <ng-container *ngIf="!codeVerified">

        <ng-container *ngIf="method === TfaMethod.TOTP">
          <div class="text-center mb-4">
            <div class="mb-3">
              <p class="text-muted mb-3" style="font-size: 14px; line-height: 1.5;">
                Use the
                <a href="https://support.google.com/accounts/answer/1066447?hl=en"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="text-primary text-decoration-none fw-medium">
                  Google Authenticator
                </a>
                or
                <a href="https://www.microsoft.com/en-us/account/authenticator"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="text-primary text-decoration-none fw-medium">
                  Microsoft Authenticator
                </a>
                app, then scan the QR code below. It will generate a 6-digit code for you to enter.
              </p>
            </div>

            <div class="qr-code-container bg-white p-0 rounded border d-inline-block">
              <img [src]="qrCodeUrl"
                   alt="QR Code"
                   class="qr-image"
                   style="max-width: 200px; height: auto;" />
            </div>
          </div>
        </ng-container>

        <!-- Email Method Info -->
        <ng-container *ngIf="method === TfaMethod.EMAIL">
          <div class="text-center mb-4">
            <div class="alert alert-info border-0 d-inline-flex align-items-center"
                 style="background-color: #e3f2fd; color: #1565c0; border-radius: 8px; font-size: 14px;">
              <i class="icon icon-envelop mr-2"></i>
              <span class="font-weight-semibold">
                Check your email for the verification code
              </span>
            </div>
          </div>
        </ng-container>

        <!-- Countdown Timer -->
        <div class="text-center mb-4">
          <div class="timer-display d-inline-block px-4 py-2 rounded"
               style="background-color: #f8f9fa; border: 1px solid #e9ecef; font-family: 'Courier New', monospace;">
            <app-countdown
              [duration]="expiresInSeconds"
              (intervalEnd)="onExpire()"
              class="fw-bold text-danger"
              style="font-size: 28px;">
            </app-countdown>
          </div>
        </div>

        <!-- Form -->
        <form (ngSubmit)="onSubmit()" #form="ngForm" novalidate>
          <div class="form-group mb-4">
            <label for="code" class="form-label text-dark mb-3 d-block text-center">
              {{ method === TfaMethod.EMAIL ? 'Enter the code sent to your email' : 'Enter the code from your authenticator app' }}
            </label>

            <div class="code-input-container">
              <input
                id="code"
                name="code"
                type="text"
                class="form-control form-control-lg text-center"
                [(ngModel)]="code"
                (ngModelChange)="errorMessage=''"
                required
                minlength="6"
                maxlength="6"
                autocomplete="one-time-code"
                placeholder="Enter code"
                [class.is-valid]="code.length === 6 && form.valid"
                [class.is-invalid]="form.submitted && (code.length < 6 || form.invalid)"
                style="font-size: 18px; letter-spacing: 4px; font-family: 'Courier New', monospace; height: 56px!important;"
              />
            </div>

            <!-- Help Text -->
            <div class="text-center mt-2">
              <small class="text-muted">
                <ng-container *ngIf="method === TfaMethod.EMAIL">
                  Didn't receive the code?
                  <button type="button"
                          class="btn btn-link p-0 text-primary fw-medium"
                          style="font-size: 12px; text-decoration: none;"
                          (click)="resendCode()">
                    Resend Code
                  </button>
                </ng-container>
                <ng-container *ngIf="method === TfaMethod.TOTP">
                  Code expires in a few minutes
                </ng-container>
              </small>
            </div>
          </div>

          <!-- Verify Button -->
          <div class="d-grid mb-3">
            <button
              type="submit"
              class="btn utm-button utm-button-primary w-100"
              [disabled]="verifying || code.length < 6"
              style="height: 48px; border-radius: 8px; font-weight: 500;">

              <ng-container *ngIf="verifying">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Verifying...
              </ng-container>

              <ng-container *ngIf="!verifying">
                <i class="fas fa-shield-check me-2"></i>
                Verify Code
              </ng-container>
            </button>
          </div>

          <!-- Error Message -->
          <div *ngIf="errorMessage"
               class="alert alert-danger border-0 text-center"
               style="background-color: #f8d7da; color: #721c24; border-radius: 8px; font-size: 14px;">
            <i class="icon-exclamation mr-2"></i>
            {{ errorMessage }}
          </div>
        </form>
      </ng-container>

      <ng-container *ngIf="codeVerified && !verifying">
        <div class="text-center">
          <div class="success-state mb-4">
            <div class="success-icon mb-3">
              <i class="icon-checkmark-circle2 text-success" style="font-size: 64px; animation: successPop 0.6s ease-out;"></i>
            </div>
            <h4 class="text-success fw-bold mb-2">Verification Successful!</h4>
            <p class="text-muted mb-4" style="line-height: 1.5;">
              Your {{ method === TfaMethod.EMAIL ? 'email authentication' : 'authenticator app' }} code has been verified successfully.
              <br>
              You can now proceed to save your Two-Factor Authentication configuration.
            </p>

            <div class="method-badge d-inline-flex align-items-center px-3 py-2 rounded mb-4"
                 style="background-color: #e3f2fd; color: #1565c0; border: 1px solid #bee5eb;">
              <i class="fas fa-shield-alt me-2"></i>
              <span class="fw-medium">
                2FA Method: {{ method === TfaMethod.EMAIL ? ' Email Authentication' : ' Authenticator App' }}
              </span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex flex-column gap-2">
            <button id="saveConfigButton"
                    class="btn utm-button utm-button-primary w-100"
                    (click)="saveConfiguration()"
                    style="height: 48px; border-radius: 8px; font-weight: 500;">
              Back to Settings
            </button>
          </div>


          <div class="mt-3">
            <small class="text-muted">
              <i class="icon-info22 me-1"></i>
              Your 2FA settings will be applied after saving the configuration
            </small>
          </div>
        </div>
      </ng-container>

      <!-- Footer Security Notice (Solo mostrar en estado inicial) -->
      <div *ngIf="!codeVerified" class="security-notice mt-4 p-3 rounded"
           style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
        <div class="d-flex align-items-start">
          <i class="fas fa-shield-alt text-warning me-2 mt-1" style="font-size: 14px;"></i>
          <small class="text-muted" style="font-size: 12px; line-height: 1.4;">
            <strong>Security Notice:</strong> Never share your authentication codes.
            UTM will never ask for your 2FA codes via email or phone.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estilos Adicionales -->
<style>
  /* Animación de éxito */
  @keyframes successPop {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Estilo del badge de método */
  .method-badge {
    font-size: 14px;
    transition: all 0.2s ease;
  }

  /* Estados de los botones */
  .btn:not(:disabled):hover {
    transform: translateY(-1px);
  }

  .btn-success:not(:disabled):hover {
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }

  /* QR Code styling */
  .qr-code-container {
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
  }

  .qr-code-container:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Timer display */
  .timer-display {
    border: 1px solid #dee2e6;
    background: linear-gradient(145deg, #f8f9fa, #ffffff);
  }

  /* Form controls */
  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .form-control.is-valid {
    border-color: #28a745;
    background-image: none;
  }

  .form-control.is-valid:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
  }

  /* Responsive */
  @media (max-width: 576px) {
    .modal-body {
      padding: 1rem !important;
    }

    .code-input-container input {
      font-size: 16px !important;
      letter-spacing: 3px !important;
      height: 48px !important;
    }

    .timer-display {
      font-size: 24px !important;
    }

    .qr-code-container {
      padding: 1rem !important;
    }

    .qr-code-container img {
      max-width: 160px !important;
    }

    .success-state i {
      font-size: 48px !important;
    }
  }
</style>
